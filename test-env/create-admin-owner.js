const { MongoClient } = require('mongodb');
const bcrypt = require('bcryptjs');
const fs = require('fs');
const path = require('path');

/**
 * ğŸ”§ SCRIPT CREARE ADMIN-OWNER
 * 
 * Acest script creeazÄƒ un utilizator admin cu rol de owner Ã®n baza de date MongoDB.
 * RespectÄƒ exact structura È™i formatul din schema User.
 * FoloseÈ™te configuraÈ›ia din fiÈ™ierul .env
 */

async function createAdminOwner() {
  // CiteÈ™te MONGO_URI din fiÈ™ierul .env
  let MONGO_URI;
  try {
    const envPath = path.resolve(process.cwd(), '.env');
    
    if (!fs.existsSync(envPath)) {
      throw new Error('.env file not found in project root');
    }
    
    const envContent = fs.readFileSync(envPath, 'utf8');
    const mongoUriMatch = envContent.match(/MONGO_URI=(.+)/);
    
    if (mongoUriMatch && mongoUriMatch[1]) {
      MONGO_URI = mongoUriMatch[1].trim();
      console.log('âœ… MONGO_URI loaded from .env file');
    } else {
      throw new Error('MONGO_URI not found in .env file');
    }
  } catch (error) {
    console.error('âŒ Error reading .env file:', error.message);
    console.log('ğŸ“‹ Make sure you have a .env file in the project root with MONGO_URI configured');
    process.exit(1);
  }
  
  const client = new MongoClient(MONGO_URI);
  
  try {
    console.log('ğŸ”— Conectare la MongoDB...');
    await client.connect();
    console.log('âœ… Conexiune MongoDB stabilitÄƒ');
    
    const db = client.db('tecsa');
    
    // VerificÄƒ dacÄƒ admin-ul existÄƒ deja
    const existingAdmin = await db.collection('users').findOne({ 
      $or: [{ username: 'admin' }, { id: 'admin' }, { email: 'admin@tecsa.com' }] 
    });
    
    if (existingAdmin) {
      console.log('âš ï¸ Admin user already exists!');
      console.log(`   ID: ${existingAdmin.id}`);
      console.log(`   Username: ${existingAdmin.username}`);
      console.log(`   Email: ${existingAdmin.email}`);
      console.log(`   Role: ${existingAdmin.role}`);
      console.log(`   Active: ${existingAdmin.isActive}`);
      return;
    }
    
    // CreeazÄƒ hash pentru parola "password"
    console.log('ğŸ” Generare hash pentru parolÄƒ...');
    const hashedPassword = await bcrypt.hash('password', 10);
    
    // CreeazÄƒ utilizatorul admin conform schemei User exacte
    const adminOwner = {
      id: "admin",                          // ID unic custom (string)
      username: "admin",                    // Nume utilizator (string, required)
      passwordHash: hashedPassword,         // Hash bcrypt (string, required)
      email: "admin@tecsa.com",            // Email unic (string, required)
      role: "owner",                       // Rol owner (enum Role, default: normal)
      theme: "default",                    // TemÄƒ UI (string, default: 'default')
      phone: "+40123456789",               // Telefon (string, optional)
      isActive: true,                      // Status activ (boolean, default: true)
      dateRegistered: new Date(),          // Data Ã®nregistrÄƒrii (Date, default: Date.now)
      createdAt: new Date(),               // Timestamp creare (auto-generated by schema)
      updatedAt: new Date()                // Timestamp actualizare (auto-generated by schema)
    };
    
    console.log('ğŸ’¾ Salvare utilizator Ã®n baza de date...');
    await db.collection('users').insertOne(adminOwner);
    
    console.log('âœ… Admin-Owner user created successfully!');
    console.log('');
    console.log('ğŸ“‹ ADMIN-OWNER CREDENTIALS:');
    console.log('   ID: admin');
    console.log('   Username: admin');
    console.log('   Password: password');
    console.log('   Email: admin@tecsa.com');
    console.log('   Role: owner');
    console.log('   Theme: default');
    console.log('   Phone: +40123456789');
    console.log('   Active: true');
    console.log('');
    console.log('ğŸ” IMPORTANT: SchimbÄƒ parola dupÄƒ primul login!');
    console.log('ğŸ‘‘ OWNER ROLE: Acces complet la toate funcÈ›ionalitÄƒÈ›ile sistemului');
    console.log('');
    console.log('ğŸš€ Pentru a testa login-ul:');
    console.log('   POST /auth/login');
    console.log('   Body: {"username": "admin", "password": "password"}');
    
  } catch (error) {
    console.error('âŒ Error creating admin-owner:', error.message);
    
    if (error.code === 11000) {
      console.log('âš ï¸ Duplicate key error - User with this ID, username or email already exists');
    } else if (error.name === 'MongoNetworkError') {
      console.log('ğŸ”— Network error - Check your internet connection and MongoDB URI');
    } else if (error.name === 'MongoServerSelectionError') {
      console.log('ğŸ”— Server selection error - Check MongoDB URI and network connectivity');
    }
    
    console.log('\nğŸ”§ Troubleshooting:');
    console.log('   1. Verify MONGO_URI in .env file is correct');
    console.log('   2. Check internet connection');
    console.log('   3. Verify MongoDB Atlas whitelist settings');
    
  } finally {
    await client.close();
    console.log('ğŸ”Œ Disconnected from MongoDB');
  }
}

// VerificÄƒ dacÄƒ scriptul este rulat direct
if (require.main === module) {
  createAdminOwner();
}

module.exports = { createAdminOwner };